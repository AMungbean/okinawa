<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†²ç»³æ—…æ¸¸è®°å½• - æˆ‘çš„ç‰çƒä¹‹æ—…</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2e7d32;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(46, 125, 50, 0.1);
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #1b5e20;
            margin-bottom: 10px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .subtitle {
            text-align: center;
            color: #558b2f;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-card {
            background: linear-gradient(135deg, #a5d6a7 0%, #81c784 100%);
            padding: 20px 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(46, 125, 50, 0.2);
            flex: 1;
            min-width: 200px;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #1b5e20;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            color: #2e7d32;
        }

        .map-container {
            position: relative;
            background: #f1f8e9;
            border-radius: 15px;
            padding: 10px;
            margin: 0 auto 30px;
            border: 3px solid #a5d6a7;
            overflow: hidden;
            /* ç«–å‘æ¯”ä¾‹ï¼Œæ›´è´´è¿‘ç‰çƒå¼§èµ°å‘ */
            max-width: 720px;
            width: 100%;
            aspect-ratio: 3 / 4;
            min-height: 600px;
        }

        #map {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            z-index: 1;
        }

        .region-marker {
            cursor: pointer;
        }

        .airport-marker {
            cursor: pointer;
        }

        .custom-popup {
            text-align: center;
            font-weight: bold;
            color: #1b5e20;
        }

        /* Leaflet å¼¹çª—æ ·å¼ */
        .leaflet-popup-content-wrapper {
            background: #f1f8e9;
            border-radius: 10px;
            border: 2px solid #81c784;
        }

        .leaflet-popup-content {
            margin: 10px;
            font-size: 14px;
        }

        .leaflet-popup-tip {
            background: #f1f8e9;
            border: 2px solid #81c784;
        }

        /* Leaflet åº•å›¾ä¸ç“¦ç‰‡çš„é»˜è®¤èƒŒæ™¯ï¼Œé¿å…é«˜å€ç¼©æ”¾æˆ–åŠ è½½ä¸­å‡ºç°ç°è‰²å— */
        .leaflet-container {
            background: #a7d7ff;
        }

        .leaflet-tile {
            background-color: #a7d7ff !important;
        }

        /* ä¸»ä½“å·¦å³å¸ƒå±€ */
        .main-layout {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            margin-top: 10px;
        }

        .map-column {
            flex: 1.1;
            display: flex;
            justify-content: center;
        }

        .side-panel {
            flex: 1;
            max-width: 420px;
            background: #f1f8e9;
            border-radius: 18px;
            padding: 20px;
            box-shadow: 0 6px 20px rgba(46, 125, 50, 0.12);
            border: 2px solid #c8e6c9;
        }

        .side-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #1b5e20;
            margin-bottom: 6px;
        }

        .side-subtitle {
            font-size: 0.9em;
            color: #558b2f;
            margin-bottom: 16px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #81c784 0%, #66bb6a 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #66bb6a 0%, #4caf50 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn-random {
            background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
            color: white;
        }

        .btn-random:hover {
            background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .region-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 10px;
            max-height: 420px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .group-title {
            margin-top: 10px;
            margin-bottom: 4px;
            font-weight: bold;
            color: #1b5e20;
            font-size: 0.95em;
        }

        .region-item {
            background: #f1f8e9;
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #c8e6c9;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .region-item:hover {
            background: #e8f5e9;
            border-color: #81c784;
            transform: translateX(5px);
        }

        .region-item.visited {
            background: #c8e6c9;
            border-color: #66bb6a;
        }

        .region-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #4caf50;
        }

        .random-result {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            border-radius: 15px;
            text-align: center;
            display: none;
            border: 3px solid #ffb74d;
        }

        .random-result.show {
            display: block;
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .random-result h3 {
            color: #f57c00;
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .random-result p {
            color: #e65100;
            font-size: 1.2em;
            font-weight: bold;
        }

        .share-section {
            text-align: center;
            margin-top: 24px;
            padding: 16px 20px;
            background: #f1f8e9;
            border-radius: 15px;
        }

        .share-btn {
            margin: 10px;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #81c784;
        }

        .legend-color.visited {
            background: #66bb6a;
        }

        .legend-color.unvisited {
            background: #c8e6c9;
        }

        .legend-color.airport {
            background: #ff6f00;
            border-color: #e65100;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .stats-bar {
                flex-direction: column;
            }

            .main-layout {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }

            .map-container {
                max-width: 100%;
                aspect-ratio: 3 / 5;
                min-height: 360px;
            }

            .side-panel {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒº æˆ‘çš„å†²ç»³æ—…æ¸¸è®°å½• ğŸŒº</h1>
        <p class="subtitle">è®°å½•ä½ åœ¨ç‰çƒè¯¸å²›çš„æ¯ä¸€æ¬¡ç¾å¥½æ—…ç¨‹</p>

        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-number" id="visitedCount">0</div>
                <div class="stat-label">å·²è®¿é—®åœ°ç‚¹</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalCount">26</div>
                <div class="stat-label">æ€»åœ°ç‚¹æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="percentage">0%</div>
                <div class="stat-label">æ¢ç´¢è¿›åº¦</div>
            </div>
        </div>

        <div class="main-layout">
            <div class="map-column">
        <div class="map-container">
                    <div id="map"></div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color unvisited"></div>
                    <span>æœªè®¿é—®</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color visited"></div>
                    <span>å·²è®¿é—®</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color airport"></div>
                    <span>æœºåœº</span>
                </div>
                    </div>
                </div>
            </div>

            <div class="side-panel">
                <div class="side-title">é€‰æ‹©ä½ å»è¿‡çš„åœ°æ–¹</div>
                <div class="side-subtitle">æŒ‰ç…§åˆ—å²›åˆ†ç»„ï¼ˆå¥„ç¾ã€å†²ç»³æœ¬å²›ã€å®«å¤ã€å…«é‡å±±ç­‰ï¼‰ï¼Œå‹¾é€‰ä½ åˆ°è®¿è¿‡çš„å²›å±¿</div>

                <div class="controls">
                    <button class="btn btn-primary" onclick="toggleSelectionMode()">
                        <span id="modeText">é€‰æ‹©æ¨¡å¼ï¼šç‚¹å‡»åœ°å›¾</span>
                    </button>
                    <button class="btn btn-secondary" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰è®°å½•</button>
                    <button class="btn btn-random" onclick="randomDestination()">ğŸ² éšæœºé€‰æ‹©ä¸‹æ¬¡ç›®çš„åœ°</button>
                </div>

                <div class="random-result" id="randomResult">
                    <h3>ğŸ¯ ä½ çš„ä¸‹ä¸€ä¸ªç›®çš„åœ°æ˜¯ï¼š</h3>
                    <p id="randomDestinationName"></p>
                </div>

                <!-- é™æ€åˆ—å²›åˆ†ç»„åˆ—è¡¨ï¼Œé¿å…è„šæœ¬å¼‚å¸¸å¯¼è‡´çœ‹ä¸åˆ°å‹¾é€‰é¡¹ -->
                <div class="region-list">
                    <!-- å¤§éš…ç¾¤å²› -->
                    <div class="group-title">å¤§éš…ç¾¤å²›</div>
                    <div class="region-item">
                        <span>å±‹ä¹…å²›</span>
                        <input type="checkbox" data-id="osumi-yakushima" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>ç§å­å²›</span>
                        <input type="checkbox" data-id="osumi-tanegashima" onchange="toggleRegionFromCheckbox(this)">
                    </div>

                    <!-- åå™¶å–‡åˆ—å²› -->
                    <div class="group-title" style="margin-top:10px;">åå™¶å–‡åˆ—å²›</div>
                    <div class="region-item">
                        <span>ä¸­ä¹‹å²›ï¼ˆåå™¶å–‡ï¼‰</span>
                        <input type="checkbox" data-id="tokara-nakanoshima" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>å£ä¹‹å²›</span>
                        <input type="checkbox" data-id="tokara-kuchinoshima" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>å®å²›</span>
                        <input type="checkbox" data-id="tokara-takarajima" onchange="toggleRegionFromCheckbox(this)">
                    </div>

                    <!-- å¥„ç¾ç¾¤å²› -->
                    <div class="group-title" style="margin-top:10px;">å¥„ç¾ç¾¤å²›</div>
                    <div class="region-item">
                        <span>å¥„ç¾å¤§å²›</span>
                        <input type="checkbox" data-id="amami-oshima" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>å¾·ä¹‹å²›</span>
                        <input type="checkbox" data-id="amami-tokunoshima" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>å†²æ°¸è‰¯éƒ¨å²›</span>
                        <input type="checkbox" data-id="amami-okinoerabu" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>ä¸è®ºå²›</span>
                        <input type="checkbox" data-id="amami-yoron" onchange="toggleRegionFromCheckbox(this)">
                    </div>

                    <!-- å†²ç»³æœ¬å²›åŠå‘¨è¾¹ -->
                    <div class="group-title" style="margin-top:10px;">å†²ç»³æœ¬å²›åŠå‘¨è¾¹</div>
                    <div class="region-item">
                        <span>å†²ç»³æœ¬å²›</span>
                        <input type="checkbox" data-id="okinawa-main" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>åº†è‰¯é—´ç¾¤å²›</span>
                        <input type="checkbox" data-id="okinawa-kerama" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>ä¹…ç±³å²›</span>
                        <input type="checkbox" data-id="okinawa-kume" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>ä¼Šæ±Ÿå²›</span>
                        <input type="checkbox" data-id="okinawa-ie" onchange="toggleRegionFromCheckbox(this)">
                    </div>

                    <!-- å®«å¤ç¾¤å²› -->
                    <div class="group-title" style="margin-top:10px;">å®«å¤ç¾¤å²›</div>
                    <div class="region-item">
                        <span>å®«å¤å²›</span>
                        <input type="checkbox" data-id="miyako-main" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>æ± é—´å²›</span>
                        <input type="checkbox" data-id="miyako-ikei" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>æ¥é—´å²›</span>
                        <input type="checkbox" data-id="miyako-kurima" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>å¤šè‰¯é—´å²›</span>
                        <input type="checkbox" data-id="miyako-tarama" onchange="toggleRegionFromCheckbox(this)">
                    </div>

                    <!-- å…«é‡å±±ç¾¤å²› -->
                    <div class="group-title" style="margin-top:10px;">å…«é‡å±±ç¾¤å²›</div>
                    <div class="region-item">
                        <span>çŸ³å£å²›</span>
                        <input type="checkbox" data-id="yaeyama-ishigaki" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>è¥¿è¡¨å²›</span>
                        <input type="checkbox" data-id="yaeyama-irihomote" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>ç«¹å¯Œå²›</span>
                        <input type="checkbox" data-id="yaeyama-taketomi" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>å°æ»¨å²›</span>
                        <input type="checkbox" data-id="yaeyama-kohama" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>é»‘å²›</span>
                        <input type="checkbox" data-id="yaeyama-kuroshima" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>æ³¢ç…§é—´å²›</span>
                        <input type="checkbox" data-id="yaeyama-hateruma" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                    <div class="region-item">
                        <span>ä¸é‚£å›½å²›</span>
                        <input type="checkbox" data-id="yaeyama-yonaguni" onchange="toggleRegionFromCheckbox(this)">
                    </div>
                </div>
            </div>
        </div>

        <div class="share-section">
            <h3 style="color: #2e7d32; margin-bottom: 15px;">åˆ†äº«ä½ çš„æ—…ç¨‹</h3>
            <button class="btn btn-primary share-btn" onclick="sharePage()">ğŸ“¤ åˆ†äº«é¡µé¢</button>
            <button class="btn btn-secondary share-btn" onclick="copyLink()">ğŸ”— å¤åˆ¶é“¾æ¥</button>
            <button class="btn btn-secondary share-btn" onclick="exportData()">ğŸ’¾ å¯¼å‡ºæ•°æ®</button>
            <button class="btn btn-secondary share-btn" onclick="importData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
        </div>
    </div>

    <script>
        // æ‰€æœ‰åŒºåŸŸæ•°æ®ï¼ˆç²¾ç®€ç‰ˆï¼šè¦†ç›–ä¸»è¦è§‚å…‰å²›å±¿ï¼ŒåŒ…å«é¢ç§¯å’ŒçœŸå®åœ°ç†åæ ‡ï¼Œå•ä½ï¼šå¹³æ–¹å…¬é‡Œï¼‰
        const regions = {
            // å¤§éš…ç¾¤å²›ï¼ˆä»£è¡¨ï¼šå±‹ä¹…å²›ï¼‰
            'osumi-yakushima': { name: 'å±‹ä¹…å²›', area: 504.88, group: 'osumi', lat: 30.3580, lng: 130.5280 },
            'osumi-tanegashima': { name: 'ç§å­å²›', area: 444.99, group: 'osumi', lat: 30.5920, lng: 130.9880 },

            // åå™¶å–‡åˆ—å²›ï¼ˆé€‰å–å‡ ä¸ªä»£è¡¨æ€§æœ‰äººå²›ï¼‰
            'tokara-nakanoshima': { name: 'ä¸­ä¹‹å²›ï¼ˆåå™¶å–‡ï¼‰', area: 34.47, group: 'tokara', lat: 29.8470, lng: 129.8500 },
            'tokara-kuchinoshima': { name: 'å£ä¹‹å²›', area: 13.33, group: 'tokara', lat: 29.9650, lng: 129.9330 },
            'tokara-takarajima': { name: 'å®å²›', area: 7.14, group: 'tokara', lat: 29.1330, lng: 129.2160 },

            // å¥„ç¾ç¾¤å²›ï¼ˆä»£è¡¨æ€§å²›å±¿ï¼‰
            'amami-oshima': { name: 'å¥„ç¾å¤§å²›', area: 712.35, group: 'amami', lat: 28.3764, lng: 129.4942 },
            'amami-tokunoshima': { name: 'å¾·ä¹‹å²›', area: 247.77, group: 'amami', lat: 27.8361, lng: 128.8811 },
            'amami-okinoerabu': { name: 'å†²æ°¸è‰¯éƒ¨å²›', area: 93.65, group: 'amami', lat: 27.4250, lng: 128.7008 },
            'amami-yoron': { name: 'ä¸è®ºå²›', area: 20.8, group: 'amami', lat: 27.0431, lng: 128.4014 },

            // å†²ç»³æœ¬å²›åŠå‘¨è¾¹
            'okinawa-main': { name: 'å†²ç»³æœ¬å²›', area: 1206.98, group: 'okinawa', lat: 26.2124, lng: 127.6809 },
            'okinawa-kerama': { name: 'åº†è‰¯é—´ç¾¤å²›', area: 35.97, group: 'okinawa', lat: 26.2000, lng: 127.3000 },
            'okinawa-kume': { name: 'ä¹…ç±³å²›', area: 59.11, group: 'okinawa', lat: 26.3636, lng: 126.7139 },
            'okinawa-ie': { name: 'ä¼Šæ±Ÿå²›', area: 22.77, group: 'okinawa', lat: 26.7167, lng: 127.7833 },

            // å®«å¤ç¾¤å²›
            'miyako-main': { name: 'å®«å¤å²›', area: 158.87, group: 'miyako', lat: 24.7828, lng: 125.2950 },
            'miyako-ikei': { name: 'æ± é—´å²›', area: 2.83, group: 'miyako', lat: 24.9333, lng: 125.2333 },
            'miyako-kurima': { name: 'æ¥é—´å²›', area: 2.84, group: 'miyako', lat: 24.7167, lng: 125.2500 },
            'miyako-tarama': { name: 'å¤šè‰¯é—´å²›', area: 19.75, group: 'miyako', lat: 24.6500, lng: 124.7000 },

            // å…«é‡å±±ç¾¤å²›
            'yaeyama-ishigaki': { name: 'çŸ³å£å²›', area: 222.65, group: 'yaeyama', lat: 24.3447, lng: 124.1869 },
            'yaeyama-irihomote': { name: 'è¥¿è¡¨å²›', area: 289.27, group: 'yaeyama', lat: 24.3667, lng: 123.7500 },
            'yaeyama-taketomi': { name: 'ç«¹å¯Œå²›', area: 5.42, group: 'yaeyama', lat: 24.3333, lng: 124.0833 },
            'yaeyama-kohama': { name: 'å°æ»¨å²›', area: 7.84, group: 'yaeyama', lat: 24.3447, lng: 124.1833 },
            'yaeyama-kuroshima': { name: 'é»‘å²›', area: 10.02, group: 'yaeyama', lat: 24.2333, lng: 123.9833 },
            'yaeyama-hateruma': { name: 'æ³¢ç…§é—´å²›', area: 12.77, group: 'yaeyama', lat: 24.0500, lng: 123.7833 },
            'yaeyama-yonaguni': { name: 'ä¸é‚£å›½å²›', area: 28.88, group: 'yaeyama', lat: 24.4667, lng: 123.0000 }
        };

        // åˆ—å²›åˆ†ç»„åç§°ï¼ˆç”¨äºå³ä¾§åˆ—è¡¨å±•ç¤ºï¼‰
        const islandGroups = {
            osumi: 'å¤§éš…ç¾¤å²›',
            tokara: 'åå™¶å–‡åˆ—å²›',
            amami: 'å¥„ç¾ç¾¤å²›',
            okinawa: 'å†²ç»³æœ¬å²›åŠå‘¨è¾¹',
            miyako: 'å®«å¤ç¾¤å²›',
            yaeyama: 'å…«é‡å±±ç¾¤å²›'
        };

        // æœºåœºæ•°æ®ï¼ˆçœŸå®åæ ‡ï¼‰
        const airports = [
            { name: 'å±‹ä¹…å²›æœºåœº', lat: 30.3856, lng: 130.6589, id: 'osumi-yakushima' },
            { name: 'ç§å­å²›æœºåœº', lat: 30.6052, lng: 130.9902, id: 'osumi-tanegashima' },
            { name: 'å¥„ç¾æœºåœº', lat: 28.4306, lng: 129.7125, id: 'amami-oshima' },
            { name: 'å–œç•Œæœºåœº', lat: 28.3214, lng: 129.9281, id: 'amami-kikai' },
            { name: 'å¾·ä¹‹å²›æœºåœº', lat: 27.8361, lng: 128.8811, id: 'amami-tokunoshima' },
            { name: 'å†²æ°¸è‰¯éƒ¨æœºåœº', lat: 27.4250, lng: 128.7008, id: 'amami-okinoerabu' },
            { name: 'ä¸è®ºæœºåœº', lat: 27.0431, lng: 128.4014, id: 'amami-yoron' },
            { name: 'é‚£éœ¸æœºåœº', lat: 26.1958, lng: 127.6456, id: 'okinawa-main' },
            { name: 'ä¹…ç±³å²›æœºåœº', lat: 26.3636, lng: 126.7139, id: 'okinawa-kume' },
            { name: 'å®«å¤æœºåœº', lat: 24.7828, lng: 125.2950, id: 'miyako-main' },
            { name: 'çŸ³å£æœºåœº', lat: 24.3447, lng: 124.1869, id: 'yaeyama-ishigaki' },
            { name: 'ä¸é‚£å›½æœºåœº', lat: 24.4669, lng: 123.0000, id: 'yaeyama-yonaguni' }
        ];

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å·²è®¿é—®çš„åœ°ç‚¹
        let visitedRegions = JSON.parse(localStorage.getItem('visitedRegions') || '[]');
        let selectionMode = 'map'; // 'map' æˆ– 'list'
        let map;
        let markers = {};
        let airportMarkers = [];
        // å›¾æ ‡å˜é‡éœ€è¦æå‡ä¸ºå…¨å±€ï¼Œä¾› updateMap() ä½¿ç”¨
        let visitedIcon, unvisitedIcon, airportIcon;

        // åˆå§‹åŒ–é¡µé¢
        function init() {
            initMap();
            updateMap();
            updateStats();
            syncCheckboxesWithVisited();
            // åˆæ¬¡æ¸²æŸ“ååˆ·æ–°ä¸€æ¬¡å°ºå¯¸ï¼Œé¿å… flex / æ¯”ä¾‹å¸ƒå±€å¯¼è‡´çš„ç¼©æ”¾é”™ä½
            setTimeout(refreshMapSize, 200);
        }

        // åˆå§‹åŒ–Leafletåœ°å›¾
        function initMap() {
            // æ ¹æ®æ‰€æœ‰å²›å±¿åæ ‡åŠ¨æ€è®¡ç®—è¾¹ç•Œï¼Œåªå›´ä½ç‰çƒå¼§é™„è¿‘ï¼Œé¿å…æ‹–åˆ°è¿œå¤„ç©ºæµ·åŸŸ
            const coords = Object.values(regions).map(r => [r.lat, r.lng]);
            const baseBounds = L.latLngBounds(coords);
            // ç•¥å¾®å¾€å››å‘¨æ‰©å±•ä¸€äº›æµ·åŸŸï¼Œpad å€¼å¯ä»¥æŒ‰éœ€è¦å¾®è°ƒ
            const paddedBounds = baseBounds.pad(0.6);
            
            // åˆ›å»ºåœ°å›¾ï¼Œåˆå§‹è§†è§’é€‚é…æ•´ä¸ªç‰çƒå¼§
            map = L.map('map', {
                center: paddedBounds.getCenter(),
                zoom: 7,
                minZoom: 5,
                maxZoom: 10, // é™åˆ¶æœ€å¤§ç¼©æ”¾ï¼Œé¿å…ç“¦ç‰‡è¾¹ç¼˜å’Œç°å—
                maxBounds: paddedBounds,
                maxBoundsViscosity: 1.0,
                zoomSnap: 0.25
            });

            // æ·»åŠ OpenStreetMapå›¾å±‚
            const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19,
                keepBuffer: 6  // åŠ å¤§ç¼“å†²ï¼Œå°½é‡æå‰åŠ è½½å‘¨è¾¹ç“¦ç‰‡
            }).addTo(map);

            // æ ¹æ®è¾¹ç•Œè‡ªé€‚åº”ä¸€æ¬¡è§†é‡ï¼Œä¿è¯åˆå§‹èƒ½çœ‹åˆ°å®Œæ•´ç‰çƒå¼§
            map.fitBounds(paddedBounds);

            // é¢„åŠ è½½å½“å‰åŒºåŸŸåœ¨å¤šä¸ªç¼©æ”¾çº§åˆ«ä¸‹çš„ç“¦ç‰‡ï¼Œé¿å…åç»­æ‹–åŠ¨/æ”¾å¤§æ—¶å‡ºç°æœªåŠ è½½å—
            preloadTiles(paddedBounds, 5, 10);

            // åˆ›å»ºè‡ªå®šä¹‰å›¾æ ‡ï¼ˆå°½é‡ä¸é®ä½å°å²›ï¼Œç”¨ç»†è¾¹æ¡†åœ†åœˆè¡¨ç¤ºï¼‰
            const createRingIcon = (borderColor, fillColor, size = 16, borderWidth = 3) => {
                return L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: ${size}px;
                        height: ${size}px;
                        background-color: ${fillColor};
                        border: ${borderWidth}px solid ${borderColor};
                        border-radius: 50%;
                        box-shadow: 0 1px 4px rgba(0,0,0,0.25);
                    "></div>`,
                    iconSize: [size, size],
                    iconAnchor: [size/2, size/2]
                });
            };

            // å·²è®¿é—®ï¼šç»†ç»¿è‰²åœ†ç¯ï¼Œä¸­å¿ƒåŸºæœ¬é€æ˜ï¼ˆæå‡ä¸ºå…¨å±€å˜é‡ï¼‰
            visitedIcon = createRingIcon('#2e7d32', 'rgba(102,187,106,0.15)', 16, 3);
            // æœªè®¿é—®ï¼šæ›´å°ã€æµ…ç»¿è‰²åœ†ç¯ï¼ˆæå‡ä¸ºå…¨å±€å˜é‡ï¼‰
            unvisitedIcon = createRingIcon('#81c784', 'rgba(200,230,201,0.1)', 12, 2);
            // æœºåœºï¼šå°æ©™è‰²å®å¿ƒç‚¹ï¼ˆæå‡ä¸ºå…¨å±€å˜é‡ï¼‰
            airportIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    width: 10px;
                    height: 10px;
                    background-color: #ff6f00;
                    border: 2px solid #ffe082;
                    border-radius: 50%;
                    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [10, 10],
                iconAnchor: [5, 5]
            });

            // ä¸ºæ¯ä¸ªåŒºåŸŸåˆ›å»ºæ ‡è®°
            Object.entries(regions).forEach(([id, data]) => {
                const isVisited = visitedRegions.includes(id);
                const icon = isVisited ? visitedIcon : unvisitedIcon;
                
                // ä½¿ç”¨ç²¾ç¡®çš„åæ ‡åˆ›å»ºæ ‡è®°ï¼Œç¡®ä¿å®šä½å‡†ç¡®
                const marker = L.marker([data.lat, data.lng], { 
                    icon: icon,
                    draggable: false,
                    keyboard: true
                })
                    .addTo(map)
                    .bindPopup(`<div class="custom-popup">${data.name}<br>${isVisited ? 'âœ“ å·²è®¿é—®' : 'æœªè®¿é—®'}</div>`, {
                        className: 'custom-popup'
                    });

                marker.on('click', () => {
                    toggleRegion(id);
                });

                markers[id] = marker;
            });

            // æ·»åŠ æœºåœºæ ‡è®°
            airports.forEach(airport => {
                const marker = L.marker([airport.lat, airport.lng], { icon: airportIcon })
                    .addTo(map)
                    .bindPopup(`<div class="custom-popup">âœˆï¸ ${airport.name}</div>`, {
                        className: 'custom-popup'
                    });
                airportMarkers.push(marker);
            });
        }

        // å½“å®¹å™¨å°ºå¯¸å˜åŒ–æ—¶ï¼Œåˆ·æ–°åœ°å›¾å°ºå¯¸
        function refreshMapSize() {
            if (map) {
                map.invalidateSize();
            }
        }

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', refreshMapSize);

        // é¢„åŠ è½½ç»™å®šè¾¹ç•Œå’Œç¼©æ”¾èŒƒå›´å†…çš„æ‰€æœ‰ç“¦ç‰‡ï¼ˆä¼šåˆ©ç”¨æµè§ˆå™¨ç¼“å­˜ï¼Œåç»­ä¸ä¼šé‡å¤è¯·æ±‚ï¼‰
        function preloadTiles(bounds, minZoom, maxZoom) {
            const urlTemplate = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
            const north = bounds.getNorth();
            const south = bounds.getSouth();
            const west = bounds.getWest();
            const east = bounds.getEast();

            const toRad = deg => deg * Math.PI / 180;

            function lon2tile(lon, z) {
                return Math.floor((lon + 180) / 360 * Math.pow(2, z));
            }

            function lat2tile(lat, z) {
                const n = Math.log(Math.tan(Math.PI / 4 + toRad(lat) / 2));
                return Math.floor((1 - n / Math.PI) / 2 * Math.pow(2, z));
            }

            for (let z = minZoom; z <= maxZoom; z++) {
                const xMin = lon2tile(west, z);
                const xMax = lon2tile(east, z);
                const yMin = lat2tile(north, z);
                const yMax = lat2tile(south, z);

                for (let x = xMin; x <= xMax; x++) {
                    for (let y = yMin; y <= yMax; y++) {
                        const url = urlTemplate
                            .replace('{z}', z)
                            .replace('{x}', x)
                            .replace('{y}', y);
                        const img = new Image();
                        img.src = url;
                    }
                }
            }
        }

        // æ›´æ–°åœ°å›¾æ˜¾ç¤º
        function updateMap() {
            if (!map) return;

            Object.entries(regions).forEach(([id, data]) => {
                if (markers[id]) {
                    const isVisited = visitedRegions.includes(id);
                    const newIcon = isVisited ? visitedIcon : unvisitedIcon;
                    markers[id].setIcon(newIcon);
                    markers[id].setPopupContent(`<div class="custom-popup">${data.name}<br>${isVisited ? 'âœ“ å·²è®¿é—®' : 'æœªè®¿é—®'}</div>`);
                }
            });
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const visitedCount = visitedRegions.length;
            const totalCount = Object.keys(regions).length;
            const totalArea = Object.values(regions).reduce((sum, r) => sum + r.area, 0);
            const visitedArea = visitedRegions.reduce((sum, id) => sum + (regions[id]?.area || 0), 0);
            const percentage = totalArea > 0 ? ((visitedArea / totalArea) * 100).toFixed(1) : 0;

            document.getElementById('visitedCount').textContent = visitedCount;
            document.getElementById('totalCount').textContent = totalCount;
            document.getElementById('percentage').textContent = percentage + '%';
        }

        // åˆ—è¡¨å‹¾é€‰ä¸å·²è®¿é—®æ•°æ®åŒæ­¥
        function syncCheckboxesWithVisited() {
            document.querySelectorAll('.region-list .region-item').forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                if (!checkbox) return;
                const id = checkbox.getAttribute('data-id');
                if (!id) return;
                const visited = visitedRegions.includes(id);
                checkbox.checked = visited;
                if (visited) {
                    item.classList.add('visited');
                } else {
                    item.classList.remove('visited');
                }
            });
        }

        // åˆ‡æ¢åŒºåŸŸè®¿é—®çŠ¶æ€
        function toggleRegion(id) {
            const index = visitedRegions.indexOf(id);
            if (index > -1) {
                visitedRegions.splice(index, 1);
            } else {
                visitedRegions.push(id);
            }
            saveData();
            updateMap();
            updateStats();
            syncCheckboxesWithVisited();
        }

        // ä¾›å¤é€‰æ¡†è°ƒç”¨çš„åŒ…è£…å‡½æ•°
        function toggleRegionFromCheckbox(checkbox) {
            const id = checkbox.getAttribute('data-id');
            if (!id) return;
            toggleRegion(id);
        }


        // åˆ‡æ¢é€‰æ‹©æ¨¡å¼
        function toggleSelectionMode() {
            selectionMode = selectionMode === 'map' ? 'list' : 'map';
            document.getElementById('modeText').textContent = 
                selectionMode === 'map' ? 'é€‰æ‹©æ¨¡å¼ï¼šç‚¹å‡»åœ°å›¾' : 'é€‰æ‹©æ¨¡å¼ï¼šå‹¾é€‰åˆ—è¡¨';
        }

        // æ¸…é™¤æ‰€æœ‰è®°å½•
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰è®¿é—®è®°å½•å—ï¼Ÿ')) {
                visitedRegions = [];
                saveData();
                updateMap();
                updateStats();
                syncCheckboxesWithVisited();
            }
        }

        // éšæœºé€‰æ‹©ç›®çš„åœ°
        function randomDestination() {
            const unvisited = Object.keys(regions).filter(id => !visitedRegions.includes(id));
            if (unvisited.length === 0) {
                alert('ğŸ‰ æ­å–œï¼ä½ å·²ç»è®¿é—®äº†æ‰€æœ‰åœ°ç‚¹ï¼');
                return;
            }
            const randomId = unvisited[Math.floor(Math.random() * unvisited.length)];
            const region = regions[randomId];
            
            const resultDiv = document.getElementById('randomResult');
            document.getElementById('randomDestinationName').textContent = region.name;
            resultDiv.classList.add('show');
            
            // é«˜äº®æ˜¾ç¤ºé€‰ä¸­çš„åŒºåŸŸå¹¶ç§»åŠ¨åˆ°åœ°å›¾ä¸­å¿ƒå¹¶æ”¾å¤§
            const marker = markers[randomId];
            if (marker && map) {
                const targetLatLng = [regions[randomId].lat, regions[randomId].lng];
                const targetZoom = Math.min(map.getMaxZoom ? (map.getMaxZoom() || 10) : 10, 10);

                // ä½¿ç”¨å¹³æ»‘é£è¡ŒåŠ¨ç”»å°†åœ°å›¾å±…ä¸­åˆ°ç›®æ ‡å²›å±¿å¹¶æ”¾å¤§
                map.flyTo(targetLatLng, targetZoom, {
                    animate: true,
                    duration: 1.2,
                    easeLinearity: 0.25
                });

                // åœ¨é£è¡Œç»“æŸåæ‰“å¼€å¼¹çª—ï¼Œé¿å…è¢«åŠ¨ç”»æ‰“æ–­
                map.once('moveend', () => {
                    marker.openPopup();
                });
                // æ·»åŠ é—ªçƒæ•ˆæœ
                let flashCount = 0;
                const flashInterval = setInterval(() => {
                    if (flashCount++ >= 6) {
                        clearInterval(flashInterval);
                        return;
                    }
                    const currentIcon = marker.options.icon;
                    const newIcon = flashCount % 2 === 0 
                        ? L.divIcon({
                            className: 'custom-marker',
                            html: `<div style="
                                width: 30px;
                                height: 30px;
                                background-color: #ffb74d;
                                border: 4px solid #ff9800;
                                border-radius: 50%;
                                box-shadow: 0 0 15px rgba(255,183,77,0.8);
                            "></div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                        : currentIcon;
                    marker.setIcon(newIcon);
                }, 300);
            }
        }

        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveData() {
            localStorage.setItem('visitedRegions', JSON.stringify(visitedRegions));
        }

        // åˆ†äº«é¡µé¢
        function sharePage() {
            if (navigator.share) {
                navigator.share({
                    title: 'æˆ‘çš„å†²ç»³æ—…æ¸¸è®°å½•',
                    text: `æˆ‘å·²ç»è®¿é—®äº† ${visitedRegions.length} ä¸ªåœ°ç‚¹ï¼Œæ¢ç´¢è¿›åº¦ ${document.getElementById('percentage').textContent}ï¼`,
                    url: window.location.href
                }).catch(err => console.log('åˆ†äº«å¤±è´¥', err));
            } else {
                copyLink();
            }
        }

        // å¤åˆ¶é“¾æ¥
        function copyLink() {
            const url = window.location.href;
            navigator.clipboard.writeText(url).then(() => {
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                // é™çº§æ–¹æ¡ˆ
                const textarea = document.createElement('textarea');
                textarea.value = url;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
            });
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const data = {
                visitedRegions: visitedRegions,
                exportDate: new Date().toISOString(),
                stats: {
                    visitedCount: visitedRegions.length,
                    totalCount: Object.keys(regions).length,
                    percentage: document.getElementById('percentage').textContent
                }
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å†²ç»³æ—…æ¸¸è®°å½•_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥æ•°æ®
        function importData() {
            document.getElementById('importFile').click();
        }

        // å¤„ç†å¯¼å…¥
        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.visitedRegions && Array.isArray(data.visitedRegions)) {
                        visitedRegions = data.visitedRegions;
                        saveData();
                        updateMap();
                        updateStats();
                        syncCheckboxesWithVisited();
                        alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                    } else {
                        alert('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼');
                    }
                } catch (err) {
                    alert('å¯¼å…¥å¤±è´¥ï¼š' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
